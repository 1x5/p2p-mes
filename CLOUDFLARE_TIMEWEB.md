# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Cloudflare –¥–æ–º–µ–Ω–∞ –∫ Timeweb VPS

–ë—ã—Å—Ç—Ä–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ.

## üìã –ß—Ç–æ –Ω—É–∂–Ω–æ

- ‚úÖ VPS –Ω–∞ Timeweb Cloud (Ubuntu 22.04)
- ‚úÖ –î–æ–º–µ–Ω –Ω–∞ Cloudflare
- ‚úÖ SSH –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É

## üöÄ –ë—ã—Å—Ç—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (5 –º–∏–Ω—É—Ç)

### 1. –£–∑–Ω–∞–π IP –∞–¥—Ä–µ—Å VPS

–ó–∞–π–¥–∏ –≤ –ø–∞–Ω–µ–ª—å Timeweb ‚Üí —Ç–≤–æ–π VPS ‚Üí —Å–∫–æ–ø–∏—Ä—É–π **IP –∞–¥—Ä–µ—Å**

### 2. –ù–∞—Å—Ç—Ä–æ–π DNS –≤ Cloudflare

1. Cloudflare ‚Üí —Ç–≤–æ–π –¥–æ–º–µ–Ω ‚Üí **DNS**
2. –î–æ–±–∞–≤—å A-–∑–∞–ø–∏—Å—å:
   ```
   Type: A
   Name: @ (–∏–ª–∏ chat –¥–ª—è –ø–æ–¥–¥–æ–º–µ–Ω–∞)
   Content: IP_–ê–î–†–ï–°_VPS
   Proxy: üî¥ OFF (DNS only) ‚ö†Ô∏è –í–ê–ñ–ù–û!
   ```
3. **–°–æ—Ö—Ä–∞–Ω–∏**

‚ö†Ô∏è **–í–ê–ñ–ù–û:** Proxy –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–í–´–ö–õ–Æ–ß–ï–ù** (—Å–µ—Ä–∞—è —Ç—É—á–∫–∞), –∏–Ω–∞—á–µ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!

### 3. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É

```bash
ssh root@—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com
# –∏–ª–∏
ssh root@IP_–ê–î–†–ï–°
```

### 4. –°–∫–æ–ø–∏—Ä—É–π –∏ –∑–∞–ø—É—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏

**–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ** –≤—ã–ø–æ–ª–Ω–∏:

```bash
# –°–∫–∞—á–∞–π —Å–∫—Ä–∏–ø—Ç
curl -O https://raw.githubusercontent.com/—Ç–≤–æ–π-—Ä–µ–ø–æ/p2p-mes/master/setup-timeweb-server.sh

# –ò–ª–∏ —Å–æ–∑–¥–∞–π –≤—Ä—É—á–Ω—É—é
nano setup-timeweb-server.sh
# –í—Å—Ç–∞–≤—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ —Ñ–∞–π–ª–∞ setup-timeweb-server.sh

# –°–¥–µ–ª–∞–π –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x setup-timeweb-server.sh

# –ó–∞–ø—É—Å—Ç–∏
sudo bash setup-timeweb-server.sh
```

–°–∫—Ä–∏–ø—Ç —Å–ø—Ä–æ—Å–∏—Ç –¥–æ–º–µ–Ω - –≤–≤–µ–¥–∏ –µ–≥–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `chat.example.com`)

–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç Node.js, PM2, Nginx
- ‚úÖ –ü–æ–ª—É—á–∏—Ç SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (Let's Encrypt)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç Nginx –¥–ª—è WebSocket
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–∏—Ç Firewall

### 5. –°–∫–æ–ø–∏—Ä—É–π –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

**–° –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ Mac:**

```bash
cd /Users/ff/Documents/cursor/p2p-mes

# –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π –¥–æ–º–µ–Ω –∏–ª–∏ IP
scp server.js package.json root@—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com:/var/www/p2p-mes/
```

### 6. –ó–∞–ø—É—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:**

```bash
cd /var/www/p2p-mes

# –£—Å—Ç–∞–Ω–æ–≤–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
npm install --production

# –ó–∞–ø—É—Å—Ç–∏ —á–µ—Ä–µ–∑ PM2
pm2 start server.js --name p2p-messenger

# –°–æ—Ö—Ä–∞–Ω–∏ –∫–æ–Ω—Ñ–∏–≥ PM2
pm2 save

# –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
pm2 startup
```

### 7. –û–±–Ω–æ–≤–∏ –∫–ª–∏–µ–Ω—Ç (app.js)

**–ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º Mac** –≤ —Ñ–∞–π–ª–µ `app.js` –∏–∑–º–µ–Ω–∏:

```javascript
const WS_URL = 'wss://—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com';
// –ù–∞–ø—Ä–∏–º–µ—Ä: const WS_URL = 'wss://chat.example.com';
```

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:

```bash
npm start
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

### –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
ssh root@—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com

# –°—Ç–∞—Ç—É—Å PM2
pm2 status

# –õ–æ–≥–∏
pm2 logs p2p-messenger

# Nginx —Å—Ç–∞—Ç—É—Å
systemctl status nginx

# –õ–æ–≥–∏ Nginx
tail -f /var/log/nginx/p2p-error.log
```

### –ü—Ä–æ–≤–µ—Ä—å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:

```bash
# –° –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ Mac
curl -i -N -H "Connection: Upgrade" \
  -H "Upgrade: websocket" \
  -H "Sec-WebSocket-Version: 13" \
  -H "Sec-WebSocket-Key: test" \
  https://—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com
```

–î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: `HTTP/1.1 101 Switching Protocols`

### –ü—Ä–æ–≤–µ—Ä—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:

–ó–∞–ø—É—Å—Ç–∏ `npm start` –Ω–∞ –¥–≤—É—Ö Mac - –¥–æ–ª–∂–Ω—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç! üéâ

## üîß Troubleshooting

### DNS –Ω–µ –æ–±–Ω–æ–≤–∏–ª—Å—è

–ü–æ–¥–æ–∂–¥–∏ 5-10 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è DNS –≤ Cloudflare.

–ü—Ä–æ–≤–µ—Ä—å DNS:
```bash
dig —Ç–≤–æ–π-–¥–æ–º–µ–Ω.com
nslookup —Ç–≤–æ–π-–¥–æ–º–µ–Ω.com
```

### SSL –æ—à–∏–±–∫–∞

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–æ–≤–µ—Ä—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
certbot certificates

# –û–±–Ω–æ–≤–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
certbot renew --force-renewal
systemctl reload nginx
```

### WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

1. **–ü—Ä–æ–≤–µ—Ä—å Cloudflare Proxy** - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–í–´–ö–õ–Æ–ß–ï–ù** (üî¥ DNS only)
2. **–ü—Ä–æ–≤–µ—Ä—å firewall:**
   ```bash
   ufw status
   ufw allow 443/tcp
   ```
3. **–ü—Ä–æ–≤–µ—Ä—å Nginx –ª–æ–≥–∏:**
   ```bash
   tail -f /var/log/nginx/p2p-error.log
   ```

### –ü–æ—Ä—Ç 3000 –∑–∞–Ω—è—Ç

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
lsof -i:3000
kill -9 <PID>
pm2 restart p2p-messenger
```

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º Mac
scp server.js root@—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com:/var/www/p2p-mes/

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
ssh root@—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com
cd /var/www/p2p-mes
pm2 restart p2p-messenger
```

## üìä –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# PM2
pm2 status                    # –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
pm2 logs p2p-messenger       # –õ–æ–≥–∏
pm2 restart p2p-messenger    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
pm2 stop p2p-messenger       # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
pm2 monit                    # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

# Nginx
systemctl status nginx       # –°—Ç–∞—Ç—É—Å
systemctl reload nginx       # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
nginx -t                     # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞

# SSL
certbot certificates         # –°–ø–∏—Å–æ–∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
certbot renew               # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
```

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è —Ä–∞–±–æ—Ç–∞–µ—Ç P2P –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–∞ `wss://—Ç–≤–æ–π-–¥–æ–º–µ–Ω.com` —Å SSL! 

–ú–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è —Å –ª—é–±—ã—Ö Mac —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç! üöÄ

